

# 策略配置

### 1 技术选型 采用 bpmnjs


基于SVG: 可缩放矢量图  高保真
BPMN business Process modeling notation



对比：
- antv G6 (阿里 蚂蚁)  可选择是使用cavas 还是 SVG 
- logicFlow 

为什么选择：
1. 司内参考的星航系统使用了
2. 默认UI 更符合业务要求， 改造成本更低
3. 基于 BPMN 规范，扩展性、可配置型更强。
4. 流程图输出的配置数据，可以是xml 也可以是 json 和 yaml 可选性很强

     

SVG 和 canvas 对比： 
1、 canvas 渲染性能好， 但是缩放可能失真， canvas 不支持事件处理 不能渲染矢量图，得转换为位图
2、 SVG 不适合高频次的动图渲染， 但SVG 图片可以绑定事件，可以使用css 控制

https://zhuanlan.zhihu.com/p/618366802

#### 关键技术：

有限状态机实现 公式编辑输入

功能： 支持： 业务字段输入（通过后端接口拉取）
  下拉选择器 字段选择的时候，模糊查询 等，都有
  结算策略公式 输入， 支持 常见的 + - * / ， 通过键盘和页面的虚拟键盘都可以输入， 虚拟键盘hover 展示。 同时 对于 公式的展示，有高亮和格式化，方便阅读。

  具体实现： 有一个隐藏的input 框，作为输入监听，使用textarea 作为公式展示（ 版本1） 
  后来为了更好的高亮、格式化，自己实现了公式展示的组件。

  技术难点： 公式校验、 有限状态机，
    公式解析：自己写的逻辑，递归，匹配关键字。 主要是 去括号的逻辑。
  协议转换： 
    定义的pb协议， pb 比起json ，序列化和反序列化，可以帮助我们进行数据的校验。但是灵活度不够，树状结构描述 公式，不等式。
    需要把前端表单数据转换成约定好的pb 协议。
  前端工作量很重。
  相反，后端主要是数据存储了。

  多人协作的加锁问题

  redis 缓存问题。

  

